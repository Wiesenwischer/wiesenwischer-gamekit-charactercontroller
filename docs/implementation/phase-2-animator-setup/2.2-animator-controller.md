# 2.2 Animator Controller erstellen

**Commit:** `feat(phase-2): 2.2 Animator Controller erstellen`

---

## Ziel

Den Animator Controller mit Layer-Struktur und allen benötigten Parametern erstellen.

---

## Animator Controller

### Erstellen

1. **Assets → Create → Animator Controller**
2. Benennen: `CharacterAnimatorController`
3. Speichern in: `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Resources/AnimatorControllers/`

### Parameter anlegen

Im Animator-Fenster unter **Parameters** folgende Parameter hinzufügen:

| Parameter | Typ | Default | Beschreibung |
|-----------|-----|---------|-------------|
| `Speed` | Float | 0 | Normalisierte Bewegungsgeschwindigkeit |
| `IsGrounded` | Bool | true | Bodenkontakt |
| `VerticalVelocity` | Float | 0 | Vertikale Geschwindigkeit |
| `Jump` | Trigger | - | Löst Jump-Animation aus |
| `Land` | Trigger | - | Löst Land-Animation aus |
| `HardLanding` | Bool | false | Unterscheidet weiche/harte Landung |

> **Hinweis:** Die Parameter-Namen müssen exakt mit `AnimationParameters.cs` übereinstimmen. Der `HardLanding`-Parameter wird als neuer Hash in `AnimationParameters.cs` ergänzt.

---

## Layer-Konfiguration

### Layer 0: Base Layer

| Eigenschaft | Wert |
|-------------|------|
| Name | `Base Layer` |
| Weight | 1.0 |
| Mask | Keine (ganzer Körper) |
| Blending | Override |
| Sync | Aus |
| IK Pass | Aus (wird in Phase 7 aktiviert) |

> **Hinweis:** Der Base Layer verwendet keine Mask, da er den ganzen Körper steuert. Erst wenn Layer 1 aktiv wird (Weight > 0), überschreibt die UpperBody-Mask den Oberkörper.

### Layer 1: Abilities

| Eigenschaft | Wert |
|-------------|------|
| Name | `Abilities` |
| Weight | 0.0 (default, wird zur Laufzeit gesetzt) |
| Mask | `Mask_UpperBody` |
| Blending | Override |
| Sync | Aus |
| IK Pass | Aus |

**States für Layer 1:**
- `Empty` (Default State) – Kein Override, Base Layer ist sichtbar
- Weitere States werden in Phase 4 (Ability System) und Phase 8 (Combat) hinzugefügt

### Layer 2: Status

> Aus der [AAA Action Combat Architecture](../../specs/AAA_Action_Combat_Character_Architecture.md): Status-Effekte (Stunned, Rooted, Dead) bilden eine eigene logische Schicht mit höchster Priorität, die Movement und Abilities überschreibt.

| Eigenschaft | Wert |
|-------------|------|
| Name | `Status` |
| Weight | 0.0 (default, wird zur Laufzeit gesetzt) |
| Mask | Keine (Full-Body Override) |
| Blending | Override |
| Sync | Aus |
| IK Pass | Aus |

**States für Layer 2:**
- `Empty` (Default State) – Kein Override, darunter liegende Layer sind sichtbar
- Weitere States (Stunned, Knockback, Dead) werden in späteren Phasen hinzugefügt

> **Hinweis:** Layer 2 hat **keine Mask**, da Status-Animationen den gesamten Körper überschreiben sollen. Wenn Weight=0, ist der Layer unsichtbar und Layer 0+1 spielen normal. Erst wenn ein Status aktiv wird (Weight → 1.0), übernimmt er die volle Kontrolle.

---

## AnimationParameters.cs erweitern

Der `HardLanding`-Parameter muss in `AnimationParameters.cs` ergänzt werden:

```csharp
// Bestehende Parameter (aus Phase 1.4):
public const string SpeedParam = "Speed";
public const string IsGroundedParam = "IsGrounded";
public const string VerticalVelocityParam = "VerticalVelocity";
public const string JumpTrigger = "Jump";
public const string LandTrigger = "Land";

// NEU: HardLanding Parameter
public const string HardLandingParam = "HardLanding";
public static readonly int HardLandingHash = Animator.StringToHash(HardLandingParam);

// Layer-Indizes (erweitert)
public const int BaseLayerIndex = 0;
public const int AbilityLayerIndex = 1;
public const int StatusLayerIndex = 2;
```

---

## Variante: Editor-Script

Falls der Controller programmatisch erstellt werden soll:

**Datei:** `Packages/.../Editor/AnimatorControllerCreator.cs`

```csharp
using UnityEditor;
using UnityEditor.Animations;
using UnityEngine;

namespace Wiesenwischer.GameKit.CharacterController.Animation.Editor
{
    public static class AnimatorControllerCreator
    {
        private const string ControllerPath =
            "Packages/Wiesenwischer.GameKit.CharacterController.Animation/Resources/AnimatorControllers/";

        [MenuItem("Wiesenwischer/GameKit/Create Animator Controller")]
        public static void CreateController()
        {
            var controller = AnimatorController.CreateAnimatorControllerAtPath(
                ControllerPath + "CharacterAnimatorController.controller");

            // Parameter hinzufügen
            controller.AddParameter(AnimationParameters.SpeedParam, AnimatorControllerParameterType.Float);
            controller.AddParameter(AnimationParameters.IsGroundedParam, AnimatorControllerParameterType.Bool);
            controller.AddParameter(AnimationParameters.VerticalVelocityParam, AnimatorControllerParameterType.Float);
            controller.AddParameter(AnimationParameters.JumpTrigger, AnimatorControllerParameterType.Trigger);
            controller.AddParameter(AnimationParameters.LandTrigger, AnimatorControllerParameterType.Trigger);
            controller.AddParameter(AnimationParameters.HardLandingParam, AnimatorControllerParameterType.Bool);

            // Layer 1: Abilities (Layer 0 existiert bereits als "Base Layer")
            var upperBodyMask = AssetDatabase.LoadAssetAtPath<AvatarMask>(
                "Packages/Wiesenwischer.GameKit.CharacterController.Animation/Resources/AvatarMasks/Mask_UpperBody.mask");

            var abilityLayer = new AnimatorControllerLayer
            {
                name = "Abilities",
                defaultWeight = 0f,
                avatarMask = upperBodyMask,
                blendingMode = AnimatorLayerBlendingMode.Override,
                stateMachine = new AnimatorStateMachine()
            };

            // Empty Default State für Ability Layer
            var emptyState = abilityLayer.stateMachine.AddState("Empty");
            abilityLayer.stateMachine.defaultState = emptyState;

            controller.AddLayer(abilityLayer);

            // Layer 2: Status (Full-Body Override für Stun, Knockback, Death)
            var statusLayer = new AnimatorControllerLayer
            {
                name = "Status",
                defaultWeight = 0f,
                avatarMask = null, // Full-Body Override
                blendingMode = AnimatorLayerBlendingMode.Override,
                stateMachine = new AnimatorStateMachine()
            };

            var statusEmptyState = statusLayer.stateMachine.AddState("Empty");
            statusLayer.stateMachine.defaultState = statusEmptyState;

            controller.AddLayer(statusLayer);

            EditorUtility.SetDirty(controller);
            AssetDatabase.SaveAssets();
            Debug.Log("[AnimatorControllerCreator] Animator Controller erstellt.");
        }
    }
}
```

---

## Verifikation

- [ ] `CharacterAnimatorController.controller` existiert
- [ ] 6 Parameter vorhanden: Speed, IsGrounded, VerticalVelocity, Jump, Land, HardLanding
- [ ] Layer 0 "Base Layer" mit Weight 1.0, keine Mask
- [ ] Layer 1 "Abilities" mit Weight 0.0, Mask_UpperBody zugewiesen
- [ ] Layer 1 hat "Empty" als Default State
- [ ] Layer 2 "Status" mit Weight 0.0, keine Mask (Full-Body Override)
- [ ] Layer 2 hat "Empty" als Default State
- [ ] `AnimationParameters.cs` enthält `HardLandingParam`, `HardLandingHash` und `StatusLayerIndex`
- [ ] Keine Compiler-Fehler

---

## Dateien nach diesem Schritt

```
Packages/Wiesenwischer.GameKit.CharacterController.Animation/
├── Editor/
│   ├── AvatarMaskCreator.cs
│   └── AnimatorControllerCreator.cs    (optional)
├── Runtime/
│   └── Core/
│       └── AnimationParameters.cs       (erweitert um HardLanding)
└── Resources/
    ├── AnimatorControllers/
    │   └── CharacterAnimatorController.controller
    └── AvatarMasks/
        ├── Mask_UpperBody.mask
        ├── Mask_LowerBody.mask
        └── Mask_ArmsOnly.mask
```

---

## Nächster Schritt

[2.3 Locomotion Blend Tree](2.3-locomotion-blend-tree.md)
