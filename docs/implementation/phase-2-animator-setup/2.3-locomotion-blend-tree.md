# 2.3 Locomotion Blend Tree

**Commit:** `feat(phase-2): 2.3 Locomotion Blend Tree`

---

## Ziel

Einen 1D Blend Tree für Locomotion im Base Layer erstellen, der nahtlos zwischen Idle, Walk, Run und Sprint blendet.

---

## Blend Tree Konfiguration

### Erstellen

1. Animator Controller öffnen: `CharacterAnimatorController`
2. Im **Base Layer** Rechtsklick → **Create State → From New Blend Tree**
3. Benennen: `Locomotion`
4. Als **Default State** setzen (orange markiert)

### Blend Tree Settings

| Eigenschaft | Wert |
|-------------|------|
| Blend Type | 1D |
| Parameter | `Speed` |

### Motion-Einträge

| # | Motion (Clip) | Threshold | Beschreibung |
|---|---------------|-----------|-------------|
| 0 | `Idle` | 0.0 | Stillstehen |
| 1 | `Walk` | 0.5 | Gehen |
| 2 | `Run` | 1.0 | Laufen |
| 3 | `Sprint` | 1.5 | Sprinten |

> **Threshold-Erklärung:** Die Werte entsprechen der normalisierten Geschwindigkeit (`horizontalSpeed / RunSpeed`). Walk = WalkSpeed/RunSpeed = 3/6 = 0.5, Run = 1.0, Sprint = 1.5.

### Erweiterte Einstellungen

| Eigenschaft | Wert | Erklärung |
|-------------|------|-----------|
| Automate Thresholds | Aus | Manuelle Thresholds verwenden |
| Compute Thresholds | - | Nicht verwenden |
| Adjust Time Scale | Aus | Animation-Geschwindigkeit nicht auto-skalieren |

---

## Clip-Anforderungen

Die Animation-Clips müssen folgende Eigenschaften haben:

| Clip | Loop | Root Motion | Hinweis |
|------|------|-------------|---------|
| `Idle` | Ja | Nein | Stehende Pose, Atem-Animation |
| `Walk` | Ja | Nein | Langsamer Gang |
| `Run` | Ja | Nein | Normales Laufen |
| `Sprint` | Ja | Nein | Schnelles Rennen |

> **Root Motion:** Wird nicht verwendet, da die Bewegung über den KCC Motor gesteuert wird (velocity-driven, nicht animation-driven).

### Clip-Import-Einstellungen

Für jeden Clip im FBX Import Inspector prüfen:
- **Loop Time:** ✅ Aktiviert
- **Root Transform Rotation:** Bake Into Pose ✅, Based Upon: Original
- **Root Transform Position (Y):** Bake Into Pose ✅, Based Upon: Original
- **Root Transform Position (XZ):** Bake Into Pose ✅, Based Upon: Original

---

## Variante: Editor-Script

Blend Tree programmatisch erstellen:

```csharp
// Innerhalb von AnimatorControllerCreator.cs (Erweiterung)

private static void CreateLocomotionBlendTree(AnimatorController controller)
{
    var rootStateMachine = controller.layers[0].stateMachine;

    // Blend Tree erstellen
    var blendTree = new BlendTree
    {
        name = "Locomotion",
        blendType = BlendTreeType.Simple1D,
        blendParameter = AnimationParameters.SpeedParam,
        useAutomaticThresholds = false
    };

    // Clips laden (aus Resources oder direkt per Pfad)
    var idleClip = LoadClip("Idle");
    var walkClip = LoadClip("Walk");
    var runClip = LoadClip("Run");
    var sprintClip = LoadClip("Sprint");

    // Motions hinzufügen
    blendTree.AddChild(idleClip, 0.0f);
    blendTree.AddChild(walkClip, 0.5f);
    blendTree.AddChild(runClip, 1.0f);
    blendTree.AddChild(sprintClip, 1.5f);

    // Als Asset speichern (muss Sub-Asset des Controllers sein)
    AssetDatabase.AddObjectToAsset(blendTree, controller);

    // State mit Blend Tree erstellen
    var locomotionState = rootStateMachine.AddState("Locomotion");
    locomotionState.motion = blendTree;

    // Als Default State setzen
    rootStateMachine.defaultState = locomotionState;
}

private static AnimationClip LoadClip(string name)
{
    // Pfad anpassen je nach Clip-Organisation
    return AssetDatabase.LoadAssetAtPath<AnimationClip>(
        $"Packages/Wiesenwischer.GameKit.CharacterController.Animation/Resources/AnimationClips/{name}.anim");
}
```

---

## Blend-Verhalten

### Übergangs-Diagramm

```
Speed:  0.0      0.5      1.0      1.5
        |--------|--------|--------|
        Idle    Walk     Run    Sprint

  0.0  [Idle 100%]
  0.25 [Idle 50% + Walk 50%]
  0.5  [Walk 100%]
  0.75 [Walk 50% + Run 50%]
  1.0  [Run 100%]
  1.25 [Run 50% + Sprint 50%]
  1.5  [Sprint 100%]
```

### Runtime-Verhalten

Die `Speed`-Parameter-Änderung erfolgt durch die Parameter-Bridge (Schritt 2.5). Durch die Acceleration/Deceleration des Locomotion-Systems ändert sich die Geschwindigkeit graduell, was zu natürlichem Animation-Blending führt.

---

## Verifikation

- [ ] Blend Tree "Locomotion" existiert im Base Layer
- [ ] Ist als Default State gesetzt (orange)
- [ ] 4 Motions: Idle(0.0), Walk(0.5), Run(1.0), Sprint(1.5)
- [ ] Blend Parameter = "Speed"
- [ ] Automate Thresholds deaktiviert
- [ ] Preview im Animator: Speed-Slider zeigt korrekte Übergänge
- [ ] Alle Clips sind Loop-fähig

---

## Dateien nach diesem Schritt

```
Resources/
├── AnimatorControllers/
│   └── CharacterAnimatorController.controller  (aktualisiert mit Blend Tree)
└── AnimationClips/
    ├── Idle.anim        (aus Phase 1)
    ├── Walk.anim        (aus Phase 1)
    ├── Run.anim         (aus Phase 1)
    └── Sprint.anim      (aus Phase 1)
```

---

## Nächster Schritt

[2.4 Airborne States](2.4-airborne-states.md)
