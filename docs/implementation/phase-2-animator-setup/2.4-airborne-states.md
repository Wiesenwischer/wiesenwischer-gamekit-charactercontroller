# 2.4 Airborne States

**Commit:** `feat(phase-2): 2.4 Airborne States`

---

## Ziel

Animator States für Jump, Fall und Landing im Base Layer erstellen mit korrekten Transitionen.

---

## State-Übersicht

```
                    ┌──────────┐
                    │Locomotion│ (Blend Tree, Default)
                    └────┬─────┘
                         │ [Jump trigger]
                         ▼
                    ┌──────────┐
                    │   Jump   │
                    └────┬─────┘
                         │ [VerticalVelocity < 0]
                         ▼
                    ┌──────────┐
                    │   Fall   │
                    └────┬─────┘
                         │ [Land trigger]
                    ┌────┴────┐
    [!HardLanding]  │         │  [HardLanding]
                    ▼         ▼
              ┌──────────┐ ┌──────────┐
              │ SoftLand │ │ HardLand │
              └────┬─────┘ └────┬─────┘
                   │ [Exit Time] │ [Exit Time]
                   ▼             ▼
              ┌────────────────────┐
              │     Locomotion     │
              └────────────────────┘
```

---

## States erstellen

### Im Animator (Base Layer)

Rechtsklick → **Create State → Empty** für jeden State:

| State | Motion (Clip) | Speed | Loop |
|-------|---------------|-------|------|
| Jump | `Jump` | 1.0 | Nein |
| Fall | `Fall` | 1.0 | Ja |
| SoftLand | `SoftLand` | 1.0 | Nein |
| HardLand | `HardLand` | 1.0 | Nein |

### Clip-Anforderungen

| Clip | Loop | Dauer | Beschreibung |
|------|------|-------|-------------|
| `Jump` | Nein | ~0.4s | Absprung-Animation (Beine anziehen) |
| `Fall` | Ja | ~0.5s | Fallpose (Arme/Beine gestreckt) |
| `SoftLand` | Nein | ~0.3s | Leichtes Einknicken |
| `HardLand` | Nein | ~0.8s | Tiefes Einknicken, Recovery |

---

## Transitionen

### 1. Locomotion → Jump

| Eigenschaft | Wert |
|-------------|------|
| Has Exit Time | Nein |
| Transition Duration | 0.1s |
| **Condition** | `Jump` (Trigger) |

### 2. Jump → Fall

| Eigenschaft | Wert |
|-------------|------|
| Has Exit Time | Nein |
| Transition Duration | 0.15s |
| **Condition** | `VerticalVelocity` Less Than `0` |

### 3. Locomotion → Fall (direkt, z.B. von Kante fallen)

| Eigenschaft | Wert |
|-------------|------|
| Has Exit Time | Nein |
| Transition Duration | 0.2s |
| **Condition 1** | `IsGrounded` = false |
| **Condition 2** | `VerticalVelocity` Less Than `-1` |

> **Hinweis:** Der Threshold `-1` verhindert, dass kurzes "Abheben" auf unebenem Terrain sofort die Fall-Animation triggert. Der genaue Wert kann beim Feintuning angepasst werden.

### 4. Fall → SoftLand

| Eigenschaft | Wert |
|-------------|------|
| Has Exit Time | Nein |
| Transition Duration | 0.05s |
| **Condition 1** | `Land` (Trigger) |
| **Condition 2** | `HardLanding` = false |

### 5. Fall → HardLand

| Eigenschaft | Wert |
|-------------|------|
| Has Exit Time | Nein |
| Transition Duration | 0.05s |
| **Condition 1** | `Land` (Trigger) |
| **Condition 2** | `HardLanding` = true |

### 6. SoftLand → Locomotion

| Eigenschaft | Wert |
|-------------|------|
| Has Exit Time | Ja |
| Exit Time | 0.8 (80% der Animation) |
| Transition Duration | 0.2s |
| **Condition** | Keine (automatisch nach Exit Time) |

### 7. HardLand → Locomotion

| Eigenschaft | Wert |
|-------------|------|
| Has Exit Time | Ja |
| Exit Time | 0.9 (90% der Animation) |
| Transition Duration | 0.25s |
| **Condition** | Keine (automatisch nach Exit Time) |

### 8. Jump → Locomotion (Landung ohne Fall-Phase, z.B. niedriger Sprung)

| Eigenschaft | Wert |
|-------------|------|
| Has Exit Time | Nein |
| Transition Duration | 0.1s |
| **Condition** | `IsGrounded` = true |

---

## Transition-Prioritäten

Falls mehrere Transitionen gleichzeitig gültig sind, ist die Reihenfolge im Animator entscheidend. Empfohlene Priorität (von oben nach unten in der Transition-Liste):

**Für Locomotion:**
1. Jump (Trigger hat Vorrang)
2. Fall (bei Kantensturz)

**Für Fall:**
1. HardLand (Land Trigger + HardLanding = true)
2. SoftLand (Land Trigger + HardLanding = false)

---

## Erweiterte Einstellungen

### Interruption Source

Für alle Transitionen:
- **Interruption Source:** Current State
- **Ordered Interruption:** ✅

Dies erlaubt es, Transitionen durch höher priorisierte zu unterbrechen (z.B. erneuter Sprung nach SoftLand via Coyote Time).

### Write Defaults

Für alle States:
- **Write Defaults:** Aus

> **Best Practice:** Write Defaults sollte immer deaktiviert sein, um unvorhersehbare Animationszustände zu vermeiden.

---

## Vorbereitung für Animation-Driven Windows (AAA-Spec)

> Referenz: [AAA Action Combat Architecture](../../specs/AAA_Action_Combat_Character_Architecture.md), Section 10

Die AAA-Spec beschreibt **Animation-Driven Windows** als Kernmechanik für Action Combat:
- **Hit Window** – Frames in denen Damage aktiv ist
- **Cancel Window** – Animation kann unterbrochen werden (z.B. Dodge-Cancel)
- **Input Buffer Window** – Nächste Action kann vorgequeued werden

### Was bedeutet das für Phase 2?

In Phase 2 werden diese **noch nicht implementiert**, aber die Animator-Struktur muss kompatibel sein:

1. **Keine Exit-Time-Only Transitions für Combat-States** (in späteren Phasen): Combat-Transitions müssen via Conditions steuerbar sein, damit Cancel Windows funktionieren.
2. **StateMachineBehaviours** werden in Phase 8 (Combat Abilities) an Combat-States gehängt, um Window-Events auszulösen. Die aktuellen Locomotion-States brauchen keine Behaviours.
3. **AnimationEvents** können alternativ für einfache Notifications verwendet werden.

### Aktuell keine Aktion nötig

Die Airborne States hier verwenden Exit-Time-Transitions (SoftLand/HardLand → Locomotion), was für Locomotion korrekt ist. Für Combat-States in Phase 8 wird ein anderes Transition-Pattern verwendet (Condition-based mit Cancel Windows).

---

## Variante: Editor-Script (Erweiterung)

```csharp
private static void CreateAirborneStates(AnimatorController controller)
{
    var rootStateMachine = controller.layers[0].stateMachine;

    // States erstellen
    var locomotionState = FindState(rootStateMachine, "Locomotion");
    var jumpState = rootStateMachine.AddState("Jump");
    var fallState = rootStateMachine.AddState("Fall");
    var softLandState = rootStateMachine.AddState("SoftLand");
    var hardLandState = rootStateMachine.AddState("HardLand");

    // Clips zuweisen
    jumpState.motion = LoadClip("Jump");
    fallState.motion = LoadClip("Fall");
    softLandState.motion = LoadClip("SoftLand");
    hardLandState.motion = LoadClip("HardLand");

    // Write Defaults deaktivieren
    jumpState.writeDefaultValues = false;
    fallState.writeDefaultValues = false;
    softLandState.writeDefaultValues = false;
    hardLandState.writeDefaultValues = false;

    // --- Transitionen ---

    // Locomotion → Jump
    var t1 = locomotionState.AddTransition(jumpState);
    t1.hasExitTime = false;
    t1.duration = 0.1f;
    t1.AddCondition(AnimatorConditionMode.If, 0, AnimationParameters.JumpTrigger);

    // Jump → Fall
    var t2 = jumpState.AddTransition(fallState);
    t2.hasExitTime = false;
    t2.duration = 0.15f;
    t2.AddCondition(AnimatorConditionMode.Less, 0f, AnimationParameters.VerticalVelocityParam);

    // Locomotion → Fall (Kantensturz)
    var t3 = locomotionState.AddTransition(fallState);
    t3.hasExitTime = false;
    t3.duration = 0.2f;
    t3.AddCondition(AnimatorConditionMode.IfNot, 0, AnimationParameters.IsGroundedParam);
    t3.AddCondition(AnimatorConditionMode.Less, -1f, AnimationParameters.VerticalVelocityParam);

    // Fall → SoftLand
    var t4 = fallState.AddTransition(softLandState);
    t4.hasExitTime = false;
    t4.duration = 0.05f;
    t4.AddCondition(AnimatorConditionMode.If, 0, AnimationParameters.LandTrigger);
    t4.AddCondition(AnimatorConditionMode.IfNot, 0, AnimationParameters.HardLandingParam);

    // Fall → HardLand
    var t5 = fallState.AddTransition(hardLandState);
    t5.hasExitTime = false;
    t5.duration = 0.05f;
    t5.AddCondition(AnimatorConditionMode.If, 0, AnimationParameters.LandTrigger);
    t5.AddCondition(AnimatorConditionMode.If, 0, AnimationParameters.HardLandingParam);

    // SoftLand → Locomotion
    var t6 = softLandState.AddTransition(locomotionState);
    t6.hasExitTime = true;
    t6.exitTime = 0.8f;
    t6.duration = 0.2f;

    // HardLand → Locomotion
    var t7 = hardLandState.AddTransition(locomotionState);
    t7.hasExitTime = true;
    t7.exitTime = 0.9f;
    t7.duration = 0.25f;

    // Jump → Locomotion (Landung ohne Fall-Phase)
    var t8 = jumpState.AddTransition(locomotionState);
    t8.hasExitTime = false;
    t8.duration = 0.1f;
    t8.AddCondition(AnimatorConditionMode.If, 0, AnimationParameters.IsGroundedParam);
}
```

---

## Verifikation

- [ ] States existieren: Jump, Fall, SoftLand, HardLand
- [ ] Jeder State hat den korrekten Animation-Clip zugewiesen
- [ ] Write Defaults ist für alle States deaktiviert
- [ ] Locomotion → Jump Transition mit Jump-Trigger
- [ ] Jump → Fall Transition mit VerticalVelocity < 0
- [ ] Locomotion → Fall Transition (Kantensturz) mit IsGrounded=false + VerticalVelocity < -1
- [ ] Fall → SoftLand mit Land-Trigger + HardLanding=false
- [ ] Fall → HardLand mit Land-Trigger + HardLanding=true
- [ ] SoftLand → Locomotion mit Exit Time 0.8
- [ ] HardLand → Locomotion mit Exit Time 0.9
- [ ] Jump → Locomotion mit IsGrounded=true (Fallback)
- [ ] Preview im Animator: Transitionen visuell korrekt

---

## Dateien nach diesem Schritt

```
Resources/
├── AnimatorControllers/
│   └── CharacterAnimatorController.controller  (aktualisiert mit Airborne States)
└── AnimationClips/
    ├── Idle.anim
    ├── Walk.anim
    ├── Run.anim
    ├── Sprint.anim
    ├── Jump.anim       (aus Phase 1)
    ├── Fall.anim        (aus Phase 1)
    ├── SoftLand.anim    (aus Phase 1)
    └── HardLand.anim    (aus Phase 1)
```

---

## Nächster Schritt

[2.5 Parameter-Bridge](2.5-parameter-bridge.md)
